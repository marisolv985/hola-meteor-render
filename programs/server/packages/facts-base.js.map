{"version":3,"sources":["meteor://ðŸ’»app/packages/facts-base/facts_base_server.js","meteor://ðŸ’»app/packages/facts-base/facts_base_common.js"],"names":["Facts","FACTS_COLLECTION","FACTS_PUBLICATION","hasOwn","Object","prototype","hasOwnProperty","userIdFilter","userId","Package","autopublish","setUserIdFilter","filter","factsByPackage","activeSubscriptions","_factsByPackage","incrementServerFact","pkg","fact","increment","call","forEach","sub","added","packageFacts","changedField","changed","resetServerFacts","Meteor","defer","publish","ready","push","keys","onStop","activeSub","is_auto"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,SAASA,KAAK,EAAEC,gBAAgB,EAAEC,iBAAiB,QAAQ,sBAAsB;AAEjF,MAAMC,SAASC,OAAOC,SAAS,CAACC,cAAc;AAE9C,2EAA2E;AAE3E,4EAA4E;AAC5E,8BAA8B;AAC9B,IAAIC,eAAe,SAAUC,MAAM;IACjC,OAAO,CAAC,CAACC,QAAQC,WAAW;AAC9B;AAEA,4CAA4C;AAC5CV,MAAMW,eAAe,GAAG,SAAUC,MAAM;IACtCL,eAAeK;AACjB;AAEA,uEAAuE;AACvE,yBAAyB;AACzB,MAAMC,iBAAiB,CAAC;AACxB,IAAIC,sBAAsB,EAAE;AAE5B,+DAA+D;AAC/Dd,MAAMe,eAAe,GAAGF;AAExBb,MAAMgB,mBAAmB,GAAG,SAAUC,GAAG,EAAEC,IAAI,EAAEC,SAAS;IACxD,IAAI,CAAChB,OAAOiB,IAAI,CAACP,gBAAgBI,MAAM;QACrCJ,cAAc,CAACI,IAAI,GAAG,CAAC;QACvBJ,cAAc,CAACI,IAAI,CAACC,KAAK,GAAGC;QAC5BL,oBAAoBO,OAAO,CAAC,SAAUC,GAAG;YACvCA,IAAIC,KAAK,CAACtB,kBAAkBgB,KAAKJ,cAAc,CAACI,IAAI;QACtD;QACA;IACF;IAEA,MAAMO,eAAeX,cAAc,CAACI,IAAI;IACxC,IAAI,CAACd,OAAOiB,IAAI,CAACI,cAAcN,OAAO;QACpCL,cAAc,CAACI,IAAI,CAACC,KAAK,GAAG;IAC9B;IACAL,cAAc,CAACI,IAAI,CAACC,KAAK,IAAIC;IAC7B,MAAMM,eAAe,CAAC;IACtBA,YAAY,CAACP,KAAK,GAAGL,cAAc,CAACI,IAAI,CAACC,KAAK;IAC9CJ,oBAAoBO,OAAO,CAAC,SAAUC,GAAG;QACvCA,IAAII,OAAO,CAACzB,kBAAkBgB,KAAKQ;IACrC;AACF;AAEAzB,MAAM2B,gBAAgB,GAAG;IACvB,IAAK,IAAIV,OAAOJ,eAAgB;QAC9B,OAAOA,cAAc,CAACI,IAAI;IAC5B;AACF;AAEA,iEAAiE;AACjE,2EAA2E;AAC3E,UAAU;AACVW,OAAOC,KAAK,CAAC;IACX,qCAAqC;IACrCD,OAAOE,OAAO,CAAC5B,mBAAmB;QAChC,MAAMoB,MAAM,IAAI;QAChB,IAAI,CAACf,aAAa,IAAI,CAACC,MAAM,GAAG;YAC9Bc,IAAIS,KAAK;YACT;QACF;QAEAjB,oBAAoBkB,IAAI,CAACV;QACzBlB,OAAO6B,IAAI,CAACpB,gBAAgBQ,OAAO,CAAC,SAAUJ,GAAG;YAC/CK,IAAIC,KAAK,CAACtB,kBAAkBgB,KAAKJ,cAAc,CAACI,IAAI;QACtD;QACAK,IAAIY,MAAM,CAAC;YACTpB,sBACEA,oBAAoBF,MAAM,CAACuB,aAAaA,cAAcb;QAC1D;QACAA,IAAIS,KAAK;IACX,GAAG;QAACK,SAAS;IAAI;AACnB;AAME;;;;;;;;;;;;;ACjFF,MAAMpC,QAAQ,CAAC;AACf,MAAMC,mBAAmB;AACzB,MAAMC,oBAAoB;AAMxB","file":"/packages/facts-base.js","sourcesContent":["import { Facts, FACTS_COLLECTION, FACTS_PUBLICATION } from './facts_base_common';\n\nconst hasOwn = Object.prototype.hasOwnProperty;\n\n// This file is only used server-side, so no need to check Meteor.isServer.\n\n// By default, we publish facts to no user if autopublish is off, and to all\n// users if autopublish is on.\nlet userIdFilter = function (userId) {\n  return !!Package.autopublish;\n};\n\n// XXX make this take effect at runtime too?\nFacts.setUserIdFilter = function (filter) {\n  userIdFilter = filter;\n};\n\n// XXX Use a minimongo collection instead and hook up an observeChanges\n// directly to a publish.\nconst factsByPackage = {};\nlet activeSubscriptions = [];\n\n// Make factsByPackage data available to the server environment\nFacts._factsByPackage = factsByPackage;\n\nFacts.incrementServerFact = function (pkg, fact, increment) {\n  if (!hasOwn.call(factsByPackage, pkg)) {\n    factsByPackage[pkg] = {};\n    factsByPackage[pkg][fact] = increment;\n    activeSubscriptions.forEach(function (sub) {\n      sub.added(FACTS_COLLECTION, pkg, factsByPackage[pkg]);\n    });\n    return;\n  }\n\n  const packageFacts = factsByPackage[pkg];\n  if (!hasOwn.call(packageFacts, fact)) {\n    factsByPackage[pkg][fact] = 0;\n  }\n  factsByPackage[pkg][fact] += increment;\n  const changedField = {};\n  changedField[fact] = factsByPackage[pkg][fact];\n  activeSubscriptions.forEach(function (sub) {\n    sub.changed(FACTS_COLLECTION, pkg, changedField);\n  });\n};\n\nFacts.resetServerFacts = function () {\n  for (let pkg in factsByPackage) {\n    delete factsByPackage[pkg];\n  }\n};\n\n// Deferred, because we have an unordered dependency on livedata.\n// XXX is this safe? could somebody try to connect before Meteor.publish is\n// called?\nMeteor.defer(function () {\n  // XXX Also publish facts-by-package.\n  Meteor.publish(FACTS_PUBLICATION, function () {\n    const sub = this;\n    if (!userIdFilter(this.userId)) {\n      sub.ready();\n      return;\n    }\n\n    activeSubscriptions.push(sub);\n    Object.keys(factsByPackage).forEach(function (pkg) {\n      sub.added(FACTS_COLLECTION, pkg, factsByPackage[pkg]);\n    });\n    sub.onStop(function () {\n      activeSubscriptions =\n        activeSubscriptions.filter(activeSub => activeSub !== sub);\n    });\n    sub.ready();\n  }, {is_auto: true});\n});\n\nexport {\n  Facts,\n  FACTS_COLLECTION,\n  FACTS_PUBLICATION,\n};\n","const Facts = {};\nconst FACTS_COLLECTION = 'meteor_Facts_server';\nconst FACTS_PUBLICATION = 'meteor_facts';\n\nexport {\n  Facts,\n  FACTS_COLLECTION,\n  FACTS_PUBLICATION,\n};\n"]}