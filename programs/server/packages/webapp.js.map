{"version":3,"sources":["meteor://ðŸ’»app/packages/webapp/webapp_server.js","meteor://ðŸ’»app/packages/webapp/socket_file.js"],"names":["SHORT_SOCKET_TIMEOUT","LONG_SOCKET_TIMEOUT","createExpressApp","app","express","set","qs","parse","WebApp","WebAppInternals","hasOwn","Object","prototype","hasOwnProperty","NpmModules","version","Npm","require","module","defaultArch","clientPrograms","archPath","bundledJsCssUrlRewriteHook","url","bundledPrefix","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","sha1","contents","hash","createHash","update","digest","shouldCompress","req","res","headers","compress","filter","camelCase","name","parts","split","toLowerCase","i","length","charAt","toUpperCase","substring","join","identifyBrowser","userAgentString","major","minor","patch","userAgent","lookupUserAgent","family","categorizeRequest","browser","arch","modern","isModern","path","pathname","parseRequest","categorized","parseUrl","dynamicHead","dynamicBody","cookies","pathParts","archKey","startsWith","archCleaned","slice","call","splice","assign","preferredArchOrder","htmlAttributeHooks","getHtmlAttributes","request","combinedAttributes","forEach","hook","attributes","Error","addHtmlAttributeHook","push","appUrl","RoutePolicy","classify","Meteor","startup","getter","key","program","value","calculateClientHash","clientHash","calculateClientHashRefreshable","calculateClientHashNonRefreshable","calculateClientHashReplaceable","getRefreshableAssets","_timeoutAdjustmentRequestCallback","setTimeout","finishListeners","listeners","removeAllListeners","on","values","l","boilerplateByArch","boilerplateDataCallbacks","create","registerBoilerplateDataCallback","callback","previousCallback","assert","strictEqual","getBoilerplate","getBoilerplateAsync","encodeRuntimeConfig","rtimeConfig","JSON","stringify","encodeURIComponent","decodeRuntimeConfig","rtimeConfigStr","decodeURIComponent","runtimeConfig","hooks","Hook","updateHooks","isUpdatedByArch","addRuntimeConfigHook","register","boilerplate","forEachAsync","meteorRuntimeConfig","encodedCurrentConfig","baseData","updated","data","htmlAttributes","madeChanges","promise","Promise","resolve","keys","then","result","stream","toHTMLStream","statusCode","addUpdatedNotifyHook","handler","generateBoilerplateInstance","manifest","additionalOptions","runtimeConfigOverrides","cb","Boilerplate","pathMapper","itemPath","pathJoin","baseDataExtension","additionalStaticJs","entries","map","meteorRuntimeHash","rootUrlPathPrefix","sriMode","inlineScriptsAllowed","inline","staticFilesMiddleware","staticFilesByArch","next","e","serveStaticJs","s","method","settings","packages","webapp","alwaysReturnContent","writeHead","Buffer","byteLength","write","end","status","Allow","paused","info","getStaticFileInfo","maxAge","cacheable","setHeader","sourceMapUrl","type","content","send","absolutePath","maxage","dotfiles","lastModified","err","Log","error","pipe","originalPath","staticArchList","archIndex","indexOf","unshift","some","staticFiles","finalize","parsePort","port","parsedPort","parseInt","Number","isNaN","onMessage","pauseClient","generateClientProgram","runWebAppServer","shuttingDown","syncQueue","_AsynchronousQueue","getItemPathname","itemUrl","reloadClientPrograms","runTask","configJson","__meteor_bootstrap__","clientArchs","clientPaths","stack","process","exit","unpause","clientDir","pathDirname","serverDir","programJsonPath","programJson","readFileSync","code","format","item","where","sourceMap","PUBLIC_SETTINGS","configOverrides","oldProgram","newProgram","WebAppHashing","versionRefreshable","versionNonRefreshable","replaceable","versionReplaceable","_type","cordovaCompatibilityVersions","hmrVersion","manifestUrlPrefix","replace","manifestUrl","Package","autoupdate","AUTOUPDATE_VERSION","Autoupdate","autoupdateVersion","env","generateBoilerplateForArch","defaultOptionsForArch","DDP_DEFAULT_CONNECTION_URL","MOBILE_DDP_URL","absoluteUrl","ROOT_URL","MOBILE_ROOT_URL","generateBoilerplate","refreshableAssets","css","file","rawExpressHandlers","use","cookieParser","isValidUrl","getPathParts","shift","isPrefixOf","prefix","array","every","part","response","pathPrefix","search","prefixParts","meteorInternalHandlers","packageAndAppHandlers","suppressExpressErrors","query","isDevelopment","newHeaders","catch","httpServer","createServer","onListeningCallbacks","socket","destroyed","message","destroy","suppressErrors","warnedAboutConnectUsage","connectHandlers","handlers","rawConnectHandlers","rawHandlers","expressApp","suppressConnectErrors","_debug","_suppressExpressErrors","onListening","f","startListening","listenOptions","listen","exports","main","argv","startHttpServer","bindEnvironment","METEOR_PRINT_ON_LISTEN","console","log","callbacks","localPort","PORT","unixSocketPath","UNIX_SOCKET_PATH","cluster","isWorker","workerName","worker","id","removeExistingSocketFile","unixSocketPermissions","UNIX_SOCKET_PERMISSIONS","trim","test","chmodSync","unixSocketGroup","UNIX_SOCKET_GROUP","unixSocketGroupInfo","getGroupInfo","chownSync","userInfo","uid","gid","registerSocketFileCleanup","host","BIND_IP","isGetentAvailable","execSync","getGroupInfoUsingGetent","groupName","stdout","encoding","getGroupInfoFromFile","groupLine","find","line","groupInfo","setInlineScriptsAllowed","enableSubresourceIntegrity","use_credentials","setBundledJsCssUrlRewriteHook","hookFn","setBundledJsCssPrefix","self","addStaticJs","statSync","unlinkSync","existsSync","socketPath","isSocket","eventEmitter","signal"],"mappings":"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","file":"/packages/webapp.js","sourcesContent":["import assert from 'assert';\nimport { readFileSync, chmodSync, chownSync } from 'fs';\nimport { createServer } from 'http';\nimport { userInfo } from 'os';\nimport { join as pathJoin, dirname as pathDirname } from 'path';\nimport { parse as parseUrl } from 'url';\nimport { createHash } from 'crypto';\nimport express from 'express';\nimport compress from 'compression';\nimport cookieParser from 'cookie-parser';\nimport qs from 'qs';\nimport parseRequest from 'parseurl';\nimport { lookup as lookupUserAgent } from 'useragent-ng';\nimport { isModern } from 'meteor/modern-browsers';\nimport send from 'send';\nimport {\n  removeExistingSocketFile,\n  registerSocketFileCleanup,\n} from './socket_file.js';\nimport cluster from 'cluster';\nimport { execSync } from 'child_process';\n\nvar SHORT_SOCKET_TIMEOUT = 5 * 1000;\nvar LONG_SOCKET_TIMEOUT = 120 * 1000;\n\nconst createExpressApp = () => {\n  const app = express();\n  // Security and performace headers\n  // these headers come from these docs: https://expressjs.com/en/api.html#app.settings.table\n  app.set('x-powered-by', false);\n  app.set('etag', false);\n  app.set('query parser', qs.parse);\n  return app;\n}\nexport const WebApp = {};\nexport const WebAppInternals = {};\n\nconst hasOwn = Object.prototype.hasOwnProperty;\n\n\nWebAppInternals.NpmModules = {\n  express : {\n    version: Npm.require('express/package.json').version,\n    module: express,\n  }\n};\n\n// More of a convenience for the end user\nWebApp.express = express;\n\n// Though we might prefer to use web.browser (modern) as the default\n// architecture, safety requires a more compatible defaultArch.\nWebApp.defaultArch = 'web.browser.legacy';\n\n// XXX maps archs to manifests\nWebApp.clientPrograms = {};\n\n// XXX maps archs to program path on filesystem\nvar archPath = {};\n\nvar bundledJsCssUrlRewriteHook = function(url) {\n  var bundledPrefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX || '';\n  return bundledPrefix + url;\n};\n\nvar sha1 = function(contents) {\n  var hash = createHash('sha1');\n  hash.update(contents);\n  return hash.digest('hex');\n};\n\nfunction shouldCompress(req, res) {\n  if (req.headers['x-no-compression']) {\n    // don't compress responses with this request header\n    return false;\n  }\n\n  // fallback to standard filter function\n  return compress.filter(req, res);\n}\n\n// #BrowserIdentification\n//\n// We have multiple places that want to identify the browser: the\n// unsupported browser page, the appcache package, and, eventually\n// delivering browser polyfills only as needed.\n//\n// To avoid detecting the browser in multiple places ad-hoc, we create a\n// Meteor \"browser\" object. It uses but does not expose the npm\n// useragent module (we could choose a different mechanism to identify\n// the browser in the future if we wanted to).  The browser object\n// contains\n//\n// * `name`: the name of the browser in camel case\n// * `major`, `minor`, `patch`: integers describing the browser version\n//\n// Also here is an early version of a Meteor `request` object, intended\n// to be a high-level description of the request without exposing\n// details of Express's low-level `req`.  Currently it contains:\n//\n// * `browser`: browser identification object described above\n// * `url`: parsed url, including parsed query params\n//\n// As a temporary hack there is a `categorizeRequest` function on WebApp which\n// converts a Express `req` to a Meteor `request`. This can go away once smart\n// packages such as appcache are being passed a `request` object directly when\n// they serve content.\n//\n// This allows `request` to be used uniformly: it is passed to the html\n// attributes hook, and the appcache package can use it when deciding\n// whether to generate a 404 for the manifest.\n//\n// Real routing / server side rendering will probably refactor this\n// heavily.\n\n// e.g. \"Mobile Safari\" => \"mobileSafari\"\nvar camelCase = function(name) {\n  var parts = name.split(' ');\n  parts[0] = parts[0].toLowerCase();\n  for (var i = 1; i < parts.length; ++i) {\n    parts[i] = parts[i].charAt(0).toUpperCase() + parts[i].substring(1);\n  }\n  return parts.join('');\n};\n\nvar identifyBrowser = function(userAgentString) {\n  if (!userAgentString) {\n    return {\n      name: 'unknown',\n      major: 0,\n      minor: 0,\n      patch: 0\n    };\n  }\n  var userAgent = lookupUserAgent(userAgentString);\n  return {\n    name: camelCase(userAgent.family),\n    major: +userAgent.major,\n    minor: +userAgent.minor,\n    patch: +userAgent.patch,\n  };\n};\n\n// XXX Refactor as part of implementing real routing.\nWebAppInternals.identifyBrowser = identifyBrowser;\n\nWebApp.categorizeRequest = function(req) {\n  if (req.browser && req.arch && typeof req.modern === 'boolean') {\n    // Already categorized.\n    return req;\n  }\n\n  const browser = identifyBrowser(req.headers['user-agent']);\n  const modern = isModern(browser);\n  const path =\n    typeof req.pathname === 'string'\n      ? req.pathname\n      : parseRequest(req).pathname;\n\n  const categorized = {\n    browser,\n    modern,\n    path,\n    arch: WebApp.defaultArch,\n    url: parseUrl(req.url, true),\n    dynamicHead: req.dynamicHead,\n    dynamicBody: req.dynamicBody,\n    headers: req.headers,\n    cookies: req.cookies,\n  };\n\n  const pathParts = path.split('/');\n  const archKey = pathParts[1];\n\n  if (archKey.startsWith('__')) {\n    const archCleaned = 'web.' + archKey.slice(2);\n    if (hasOwn.call(WebApp.clientPrograms, archCleaned)) {\n      pathParts.splice(1, 1); // Remove the archKey part.\n      return Object.assign(categorized, {\n        arch: archCleaned,\n        path: pathParts.join('/'),\n      });\n    }\n  }\n\n  // TODO Perhaps one day we could infer Cordova clients here, so that we\n  // wouldn't have to use prefixed \"/__cordova/...\" URLs.\n  const preferredArchOrder = isModern(browser)\n    ? ['web.browser', 'web.browser.legacy']\n    : ['web.browser.legacy', 'web.browser'];\n\n  for (const arch of preferredArchOrder) {\n    // If our preferred arch is not available, it's better to use another\n    // client arch that is available than to guarantee the site won't work\n    // by returning an unknown arch. For example, if web.browser.legacy is\n    // excluded using the --exclude-archs command-line option, legacy\n    // clients are better off receiving web.browser (which might actually\n    // work) than receiving an HTTP 404 response. If none of the archs in\n    // preferredArchOrder are defined, only then should we send a 404.\n    if (hasOwn.call(WebApp.clientPrograms, arch)) {\n      return Object.assign(categorized, { arch });\n    }\n  }\n\n  return categorized;\n};\n\n// HTML attribute hooks: functions to be called to determine any attributes to\n// be added to the '<html>' tag. Each function is passed a 'request' object (see\n// #BrowserIdentification) and should return null or object.\nvar htmlAttributeHooks = [];\nvar getHtmlAttributes = function(request) {\n  var combinedAttributes = {};\n  (htmlAttributeHooks || []).forEach(function(hook) {\n    var attributes = hook(request);\n    if (attributes === null) return;\n    if (typeof attributes !== 'object')\n      throw Error('HTML attribute hook must return null or object');\n    Object.assign(combinedAttributes, attributes);\n  });\n  return combinedAttributes;\n};\nWebApp.addHtmlAttributeHook = function(hook) {\n  htmlAttributeHooks.push(hook);\n};\n\n// Serve app HTML for this URL?\nvar appUrl = function(url) {\n  if (url === '/favicon.ico' || url === '/robots.txt') return false;\n\n  // NOTE: app.manifest is not a web standard like favicon.ico and\n  // robots.txt. It is a file name we have chosen to use for HTML5\n  // appcache URLs. It is included here to prevent using an appcache\n  // then removing it from poisoning an app permanently. Eventually,\n  // once we have server side routing, this won't be needed as\n  // unknown URLs with return a 404 automatically.\n  if (url === '/app.manifest') return false;\n\n  // Avoid serving app HTML for declared routes such as /sockjs/.\n  if (RoutePolicy.classify(url)) return false;\n\n  // we currently return app HTML on all URLs by default\n  return true;\n};\n\n// We need to calculate the client hash after all packages have loaded\n// to give them a chance to populate __meteor_runtime_config__.\n//\n// Calculating the hash during startup means that packages can only\n// populate __meteor_runtime_config__ during load, not during startup.\n//\n// Calculating instead it at the beginning of main after all startup\n// hooks had run would allow packages to also populate\n// __meteor_runtime_config__ during startup, but that's too late for\n// autoupdate because it needs to have the client hash at startup to\n// insert the auto update version itself into\n// __meteor_runtime_config__ to get it to the client.\n//\n// An alternative would be to give autoupdate a \"post-start,\n// pre-listen\" hook to allow it to insert the auto update version at\n// the right moment.\n\nMeteor.startup(function() {\n  function getter(key) {\n    return function(arch) {\n      arch = arch || WebApp.defaultArch;\n      const program = WebApp.clientPrograms[arch];\n      const value = program && program[key];\n      // If this is the first time we have calculated this hash,\n      // program[key] will be a thunk (lazy function with no parameters)\n      // that we should call to do the actual computation.\n      return typeof value === 'function' ? (program[key] = value()) : value;\n    };\n  }\n\n  WebApp.calculateClientHash = WebApp.clientHash = getter('version');\n  WebApp.calculateClientHashRefreshable = getter('versionRefreshable');\n  WebApp.calculateClientHashNonRefreshable = getter('versionNonRefreshable');\n  WebApp.calculateClientHashReplaceable = getter('versionReplaceable');\n  WebApp.getRefreshableAssets = getter('refreshableAssets');\n});\n\n// When we have a request pending, we want the socket timeout to be long, to\n// give ourselves a while to serve it, and to allow sockjs long polls to\n// complete.  On the other hand, we want to close idle sockets relatively\n// quickly, so that we can shut down relatively promptly but cleanly, without\n// cutting off anyone's response.\nWebApp._timeoutAdjustmentRequestCallback = function(req, res) {\n  // this is really just req.socket.setTimeout(LONG_SOCKET_TIMEOUT);\n  req.setTimeout(LONG_SOCKET_TIMEOUT);\n  // Insert our new finish listener to run BEFORE the existing one which removes\n  // the response from the socket.\n  var finishListeners = res.listeners('finish');\n  // XXX Apparently in Node 0.12 this event was called 'prefinish'.\n  // https://github.com/joyent/node/commit/7c9b6070\n  // But it has switched back to 'finish' in Node v4:\n  // https://github.com/nodejs/node/pull/1411\n  res.removeAllListeners('finish');\n  res.on('finish', function() {\n    res.setTimeout(SHORT_SOCKET_TIMEOUT);\n  });\n  Object.values(finishListeners).forEach(function(l) {\n    res.on('finish', l);\n  });\n};\n\n// Will be updated by main before we listen.\n// Map from client arch to boilerplate object.\n// Boilerplate object has:\n//   - func: XXX\n//   - baseData: XXX\nvar boilerplateByArch = {};\n\n// Register a callback function that can selectively modify boilerplate\n// data given arguments (request, data, arch). The key should be a unique\n// identifier, to prevent accumulating duplicate callbacks from the same\n// call site over time. Callbacks will be called in the order they were\n// registered. A callback should return false if it did not make any\n// changes affecting the boilerplate. Passing null deletes the callback.\n// Any previous callback registered for this key will be returned.\nconst boilerplateDataCallbacks = Object.create(null);\nWebAppInternals.registerBoilerplateDataCallback = function(key, callback) {\n  const previousCallback = boilerplateDataCallbacks[key];\n\n  if (typeof callback === 'function') {\n    boilerplateDataCallbacks[key] = callback;\n  } else {\n    assert.strictEqual(callback, null);\n    delete boilerplateDataCallbacks[key];\n  }\n\n  // Return the previous callback in case the new callback needs to call\n  // it; for example, when the new callback is a wrapper for the old.\n  return previousCallback || null;\n};\n\n// Given a request (as returned from `categorizeRequest`), return the\n// boilerplate HTML to serve for that request.\n//\n// If a previous Express middleware has rendered content for the head or body,\n// returns the boilerplate with that content patched in otherwise\n// memoizes on HTML attributes (used by, eg, appcache) and whether inline\n// scripts are currently allowed.\n// XXX so far this function is always called with arch === 'web.browser'\nfunction getBoilerplate(request, arch) {\n  return getBoilerplateAsync(request, arch);\n}\n\n/**\n * @summary Takes a runtime configuration object and\n * returns an encoded runtime string.\n * @locus Server\n * @param {Object} rtimeConfig\n * @returns {String}\n */\nWebApp.encodeRuntimeConfig = function(rtimeConfig) {\n  return JSON.stringify(encodeURIComponent(JSON.stringify(rtimeConfig)));\n};\n\n/**\n * @summary Takes an encoded runtime string and returns\n * a runtime configuration object.\n * @locus Server\n * @param {String} rtimeConfigString\n * @returns {Object}\n */\nWebApp.decodeRuntimeConfig = function(rtimeConfigStr) {\n  return JSON.parse(decodeURIComponent(JSON.parse(rtimeConfigStr)));\n};\n\nconst runtimeConfig = {\n  // hooks will contain the callback functions\n  // set by the caller to addRuntimeConfigHook\n  hooks: new Hook(),\n  // updateHooks will contain the callback functions\n  // set by the caller to addUpdatedNotifyHook\n  updateHooks: new Hook(),\n  // isUpdatedByArch is an object containing fields for each arch\n  // that this server supports.\n  // - Each field will be true when the server updates the runtimeConfig for that arch.\n  // - When the hook callback is called the update field in the callback object will be\n  // set to isUpdatedByArch[arch].\n  // = isUpdatedyByArch[arch] is reset to false after the callback.\n  // This enables the caller to cache data efficiently so they do not need to\n  // decode & update data on every callback when the runtimeConfig is not changing.\n  isUpdatedByArch: {},\n};\n\n/**\n * @name addRuntimeConfigHookCallback(options)\n * @locus Server\n * @isprototype true\n * @summary Callback for `addRuntimeConfigHook`.\n *\n * If the handler returns a _falsy_ value the hook will not\n * modify the runtime configuration.\n *\n * If the handler returns a _String_ the hook will substitute\n * the string for the encoded configuration string.\n *\n * **Warning:** the hook does not check the return value at all it is\n * the responsibility of the caller to get the formatting correct using\n * the helper functions.\n *\n * `addRuntimeConfigHookCallback` takes only one `Object` argument\n * with the following fields:\n * @param {Object} options\n * @param {String} options.arch The architecture of the client\n * requesting a new runtime configuration. This can be one of\n * `web.browser`, `web.browser.legacy` or `web.cordova`.\n * @param {Object} options.request\n * A NodeJs [IncomingMessage](https://nodejs.org/api/http.html#http_class_http_incomingmessage)\n * https://nodejs.org/api/http.html#http_class_http_incomingmessage\n * `Object` that can be used to get information about the incoming request.\n * @param {String} options.encodedCurrentConfig The current configuration object\n * encoded as a string for inclusion in the root html.\n * @param {Boolean} options.updated `true` if the config for this architecture\n * has been updated since last called, otherwise `false`. This flag can be used\n * to cache the decoding/encoding for each architecture.\n */\n\n/**\n * @summary Hook that calls back when the meteor runtime configuration,\n * `__meteor_runtime_config__` is being sent to any client.\n *\n * **returns**: <small>_Object_</small> `{ stop: function, callback: function }`\n * - `stop` <small>_Function_</small> Call `stop()` to stop getting callbacks.\n * - `callback` <small>_Function_</small> The passed in `callback`.\n * @locus Server\n * @param {addRuntimeConfigHookCallback} callback\n * See `addRuntimeConfigHookCallback` description.\n * @returns {Object} {{ stop: function, callback: function }}\n * Call the returned `stop()` to stop getting callbacks.\n * The passed in `callback` is returned also.\n */\nWebApp.addRuntimeConfigHook = function(callback) {\n  return runtimeConfig.hooks.register(callback);\n};\n\nasync function getBoilerplateAsync(request, arch) {\n  let boilerplate = boilerplateByArch[arch];\n  await runtimeConfig.hooks.forEachAsync(async hook => {\n    const meteorRuntimeConfig = await hook({\n      arch,\n      request,\n      encodedCurrentConfig: boilerplate.baseData.meteorRuntimeConfig,\n      updated: runtimeConfig.isUpdatedByArch[arch],\n    });\n    if (!meteorRuntimeConfig) return true;\n    boilerplate.baseData = Object.assign({}, boilerplate.baseData, {\n      meteorRuntimeConfig,\n    });\n    return true;\n  });\n  runtimeConfig.isUpdatedByArch[arch] = false;\n  const { dynamicHead, dynamicBody } = request;\n  const data = Object.assign(\n    {},\n    boilerplate.baseData,\n    {\n      htmlAttributes: getHtmlAttributes(request),\n    },\n    { dynamicHead, dynamicBody }\n  );\n\n  let madeChanges = false;\n  let promise = Promise.resolve();\n\n  Object.keys(boilerplateDataCallbacks).forEach(key => {\n    promise = promise\n      .then(() => {\n        const callback = boilerplateDataCallbacks[key];\n        return callback(request, data, arch);\n      })\n      .then(result => {\n        // Callbacks should return false if they did not make any changes.\n        if (result !== false) {\n          madeChanges = true;\n        }\n      });\n  });\n\n  return promise.then(() => ({\n    stream: boilerplate.toHTMLStream(data),\n    statusCode: data.statusCode,\n    headers: data.headers,\n  }));\n}\n\n/**\n * @name addUpdatedNotifyHookCallback(options)\n * @summary callback handler for `addupdatedNotifyHook`\n * @isprototype true\n * @locus Server\n * @param {Object} options\n * @param {String} options.arch The architecture that is being updated.\n * This can be one of `web.browser`, `web.browser.legacy` or `web.cordova`.\n * @param {Object} options.manifest The new updated manifest object for\n * this `arch`.\n * @param {Object} options.runtimeConfig The new updated configuration\n * object for this `arch`.\n */\n\n/**\n * @summary Hook that runs when the meteor runtime configuration\n * is updated.  Typically the configuration only changes during development mode.\n * @locus Server\n * @param {addUpdatedNotifyHookCallback} handler\n * The `handler` is called on every change to an `arch` runtime configuration.\n * See `addUpdatedNotifyHookCallback`.\n * @returns {Object} {{ stop: function, callback: function }}\n */\nWebApp.addUpdatedNotifyHook = function(handler) {\n  return runtimeConfig.updateHooks.register(handler);\n};\n\nWebAppInternals.generateBoilerplateInstance = function(\n  arch,\n  manifest,\n  additionalOptions\n) {\n  additionalOptions = additionalOptions || {};\n\n  runtimeConfig.isUpdatedByArch[arch] = true;\n  const rtimeConfig = {\n    ...__meteor_runtime_config__,\n    ...(additionalOptions.runtimeConfigOverrides || {}),\n  };\n  runtimeConfig.updateHooks.forEach(cb => {\n    cb({ arch, manifest, runtimeConfig: rtimeConfig });\n    return true;\n  });\n\n  const meteorRuntimeConfig = JSON.stringify(\n    encodeURIComponent(JSON.stringify(rtimeConfig))\n  );\n\n  return new Boilerplate(\n    arch,\n    manifest,\n    Object.assign(\n      {\n        pathMapper(itemPath) {\n          return pathJoin(archPath[arch], itemPath);\n        },\n        baseDataExtension: {\n          additionalStaticJs: (Object.entries(additionalStaticJs) || []).map(function(\n            [pathname, contents]\n          ) {\n            return {\n              pathname: pathname,\n              contents: contents,\n            };\n          }),\n          // Convert to a JSON string, then get rid of most weird characters, then\n          // wrap in double quotes. (The outermost JSON.stringify really ought to\n          // just be \"wrap in double quotes\" but we use it to be safe.) This might\n          // end up inside a <script> tag so we need to be careful to not include\n          // \"</script>\", but normal {{spacebars}} escaping escapes too much! See\n          // https://github.com/meteor/meteor/issues/3730\n          meteorRuntimeConfig,\n          meteorRuntimeHash: sha1(meteorRuntimeConfig),\n          rootUrlPathPrefix:\n            __meteor_runtime_config__.ROOT_URL_PATH_PREFIX || '',\n          bundledJsCssUrlRewriteHook: bundledJsCssUrlRewriteHook,\n          sriMode: sriMode,\n          inlineScriptsAllowed: WebAppInternals.inlineScriptsAllowed(),\n          inline: additionalOptions.inline,\n        },\n      },\n      additionalOptions\n    )\n  );\n};\n\n// A mapping from url path to architecture (e.g. \"web.browser\") to static\n// file information with the following fields:\n// - type: the type of file to be served\n// - cacheable: optionally, whether the file should be cached or not\n// - sourceMapUrl: optionally, the url of the source map\n//\n// Info also contains one of the following:\n// - content: the stringified content that should be served at this path\n// - absolutePath: the absolute path on disk to the file\n\n// Serve static files from the manifest or added with\n// `addStaticJs`. Exported for tests.\nWebAppInternals.staticFilesMiddleware = async function(\n  staticFilesByArch,\n  req,\n  res,\n  next\n) {\n  var pathname = parseRequest(req).pathname;\n  try {\n    pathname = decodeURIComponent(pathname);\n  } catch (e) {\n    next();\n    return;\n  }\n\n  var serveStaticJs = function(s) {\n    if (\n      req.method === 'GET' ||\n      req.method === 'HEAD' ||\n      Meteor.settings.packages?.webapp?.alwaysReturnContent\n    ) {\n      res.writeHead(200, {\n        'Content-type': 'application/javascript; charset=UTF-8',\n        'Content-Length': Buffer.byteLength(s),\n      });\n      res.write(s);\n      res.end();\n    } else {\n      const status = req.method === 'OPTIONS' ? 200 : 405;\n      res.writeHead(status, {\n        Allow: 'OPTIONS, GET, HEAD',\n        'Content-Length': '0',\n      });\n      res.end();\n    }\n  };\n\n  if (\n    pathname in additionalStaticJs &&\n    !WebAppInternals.inlineScriptsAllowed()\n  ) {\n    serveStaticJs(additionalStaticJs[pathname]);\n    return;\n  }\n\n  const { arch, path } = WebApp.categorizeRequest(req);\n\n  if (!hasOwn.call(WebApp.clientPrograms, arch)) {\n    // We could come here in case we run with some architectures excluded\n    next();\n    return;\n  }\n\n  // If pauseClient(arch) has been called, program.paused will be a\n  // Promise that will be resolved when the program is unpaused.\n  const program = WebApp.clientPrograms[arch];\n  await program.paused;\n\n  if (\n    path === '/meteor_runtime_config.js' &&\n    !WebAppInternals.inlineScriptsAllowed()\n  ) {\n    serveStaticJs(\n      `__meteor_runtime_config__ = ${program.meteorRuntimeConfig};`\n    );\n    return;\n  }\n\n  const info = getStaticFileInfo(staticFilesByArch, pathname, path, arch);\n  if (!info) {\n    next();\n    return;\n  }\n  // \"send\" will handle HEAD & GET requests\n  if (\n    req.method !== 'HEAD' &&\n    req.method !== 'GET' &&\n    !Meteor.settings.packages?.webapp?.alwaysReturnContent\n  ) {\n    const status = req.method === 'OPTIONS' ? 200 : 405;\n    res.writeHead(status, {\n      Allow: 'OPTIONS, GET, HEAD',\n      'Content-Length': '0',\n    });\n    res.end();\n    return;\n  }\n\n  // We don't need to call pause because, unlike 'static', once we call into\n  // 'send' and yield to the event loop, we never call another handler with\n  // 'next'.\n\n  // Cacheable files are files that should never change. Typically\n  // named by their hash (eg meteor bundled js and css files).\n  // We cache them ~forever (1yr).\n  const maxAge = info.cacheable ? 1000 * 60 * 60 * 24 * 365 : 0;\n\n  if (info.cacheable) {\n    // Since we use req.headers[\"user-agent\"] to determine whether the\n    // client should receive modern or legacy resources, tell the client\n    // to invalidate cached resources when/if its user agent string\n    // changes in the future.\n    res.setHeader('Vary', 'User-Agent');\n  }\n\n  // Set the X-SourceMap header, which current Chrome, FireFox, and Safari\n  // understand.  (The SourceMap header is slightly more spec-correct but FF\n  // doesn't understand it.)\n  //\n  // You may also need to enable source maps in Chrome: open dev tools, click\n  // the gear in the bottom right corner, and select \"enable source maps\".\n  if (info.sourceMapUrl) {\n    res.setHeader(\n      'X-SourceMap',\n      __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + info.sourceMapUrl\n    );\n  }\n\n  if (info.type === 'js' || info.type === 'dynamic js') {\n    res.setHeader('Content-Type', 'application/javascript; charset=UTF-8');\n  } else if (info.type === 'css') {\n    res.setHeader('Content-Type', 'text/css; charset=UTF-8');\n  } else if (info.type === 'json') {\n    res.setHeader('Content-Type', 'application/json; charset=UTF-8');\n  }\n\n  if (info.hash) {\n    res.setHeader('ETag', '\"' + info.hash + '\"');\n  }\n\n  if (info.content) {\n    res.setHeader('Content-Length', Buffer.byteLength(info.content));\n    res.write(info.content);\n    res.end();\n  } else {\n    send(req, info.absolutePath, {\n      maxage: maxAge,\n      dotfiles: 'allow', // if we specified a dotfile in the manifest, serve it\n      lastModified: false, // don't set last-modified based on the file date\n    })\n      .on('error', function(err) {\n        Log.error('Error serving static file ' + err);\n        res.writeHead(500);\n        res.end();\n      })\n      .on('directory', function() {\n        Log.error('Unexpected directory ' + info.absolutePath);\n        res.writeHead(500);\n        res.end();\n      })\n      .pipe(res);\n  }\n};\n\nfunction getStaticFileInfo(staticFilesByArch, originalPath, path, arch) {\n  if (!hasOwn.call(WebApp.clientPrograms, arch)) {\n    return null;\n  }\n\n  // Get a list of all available static file architectures, with arch\n  // first in the list if it exists.\n  const staticArchList = Object.keys(staticFilesByArch);\n  const archIndex = staticArchList.indexOf(arch);\n  if (archIndex > 0) {\n    staticArchList.unshift(staticArchList.splice(archIndex, 1)[0]);\n  }\n\n  let info = null;\n\n  staticArchList.some(arch => {\n    const staticFiles = staticFilesByArch[arch];\n\n    function finalize(path) {\n      info = staticFiles[path];\n      // Sometimes we register a lazy function instead of actual data in\n      // the staticFiles manifest.\n      if (typeof info === 'function') {\n        info = staticFiles[path] = info();\n      }\n      return info;\n    }\n\n    // If staticFiles contains originalPath with the arch inferred above,\n    // use that information.\n    if (hasOwn.call(staticFiles, originalPath)) {\n      return finalize(originalPath);\n    }\n\n    // If categorizeRequest returned an alternate path, try that instead.\n    if (path !== originalPath && hasOwn.call(staticFiles, path)) {\n      return finalize(path);\n    }\n  });\n\n  return info;\n}\n\n// Parse the passed in port value. Return the port as-is if it's a String\n// (e.g. a Windows Server style named pipe), otherwise return the port as an\n// integer.\n//\n// DEPRECATED: Direct use of this function is not recommended; it is no\n// longer used internally, and will be removed in a future release.\nWebAppInternals.parsePort = port => {\n  let parsedPort = parseInt(port);\n  if (Number.isNaN(parsedPort)) {\n    parsedPort = port;\n  }\n  return parsedPort;\n};\n\nimport { onMessage } from 'meteor/inter-process-messaging';\n\nonMessage('webapp-pause-client', async ({ arch }) => {\n  await WebAppInternals.pauseClient(arch);\n});\n\nonMessage('webapp-reload-client', async ({ arch }) => {\n  await WebAppInternals.generateClientProgram(arch);\n});\n\nasync function runWebAppServer() {\n  var shuttingDown = false;\n  var syncQueue = new Meteor._AsynchronousQueue();\n\n  var getItemPathname = function(itemUrl) {\n    return decodeURIComponent(parseUrl(itemUrl).pathname);\n  };\n\n  WebAppInternals.reloadClientPrograms = async function() {\n    await syncQueue.runTask(function() {\n      const staticFilesByArch = Object.create(null);\n\n      const { configJson } = __meteor_bootstrap__;\n      const clientArchs =\n        configJson.clientArchs || Object.keys(configJson.clientPaths);\n\n      try {\n        clientArchs.forEach(arch => {\n          generateClientProgram(arch, staticFilesByArch);\n        });\n        WebAppInternals.staticFilesByArch = staticFilesByArch;\n      } catch (e) {\n        Log.error('Error reloading the client program: ' + e.stack);\n        process.exit(1);\n      }\n    });\n  };\n\n  // Pause any incoming requests and make them wait for the program to be\n  // unpaused the next time generateClientProgram(arch) is called.\n  WebAppInternals.pauseClient = async function(arch) {\n    await syncQueue.runTask(() => {\n      const program = WebApp.clientPrograms[arch];\n      const { unpause } = program;\n      program.paused = new Promise(resolve => {\n        if (typeof unpause === 'function') {\n          // If there happens to be an existing program.unpause function,\n          // compose it with the resolve function.\n          program.unpause = function() {\n            unpause();\n            resolve();\n          };\n        } else {\n          program.unpause = resolve;\n        }\n      });\n    });\n  };\n\n  WebAppInternals.generateClientProgram = async function(arch) {\n    await syncQueue.runTask(() => generateClientProgram(arch));\n  };\n\n  function generateClientProgram(\n    arch,\n    staticFilesByArch = WebAppInternals.staticFilesByArch\n  ) {\n    const clientDir = pathJoin(\n      pathDirname(__meteor_bootstrap__.serverDir),\n      arch\n    );\n\n    // read the control for the client we'll be serving up\n    const programJsonPath = pathJoin(clientDir, 'program.json');\n\n    let programJson;\n    try {\n      programJson = JSON.parse(readFileSync(programJsonPath));\n    } catch (e) {\n      if (e.code === 'ENOENT') return;\n      throw e;\n    }\n\n    if (programJson.format !== 'web-program-pre1') {\n      throw new Error(\n        'Unsupported format for client assets: ' +\n          JSON.stringify(programJson.format)\n      );\n    }\n\n    if (!programJsonPath || !clientDir || !programJson) {\n      throw new Error('Client config file not parsed.');\n    }\n\n    archPath[arch] = clientDir;\n    const staticFiles = (staticFilesByArch[arch] = Object.create(null));\n\n    const { manifest } = programJson;\n    manifest.forEach(item => {\n      if (item.url && item.where === 'client') {\n        staticFiles[getItemPathname(item.url)] = {\n          absolutePath: pathJoin(clientDir, item.path),\n          cacheable: item.cacheable,\n          hash: item.hash,\n          // Link from source to its map\n          sourceMapUrl: item.sourceMapUrl,\n          type: item.type,\n        };\n\n        if (item.sourceMap) {\n          // Serve the source map too, under the specified URL. We assume\n          // all source maps are cacheable.\n          staticFiles[getItemPathname(item.sourceMapUrl)] = {\n            absolutePath: pathJoin(clientDir, item.sourceMap),\n            cacheable: true,\n          };\n        }\n      }\n    });\n\n    const { PUBLIC_SETTINGS } = __meteor_runtime_config__;\n    const configOverrides = {\n      PUBLIC_SETTINGS,\n    };\n\n    const oldProgram = WebApp.clientPrograms[arch];\n    const newProgram = (WebApp.clientPrograms[arch] = {\n      format: 'web-program-pre1',\n      manifest: manifest,\n      // Use arrow functions so that these versions can be lazily\n      // calculated later, and so that they will not be included in the\n      // staticFiles[manifestUrl].content string below.\n      //\n      // Note: these version calculations must be kept in agreement with\n      // CordovaBuilder#appendVersion in tools/cordova/builder.js, or hot\n      // code push will reload Cordova apps unnecessarily.\n      version: () =>\n        WebAppHashing.calculateClientHash(manifest, null, configOverrides),\n      versionRefreshable: () =>\n        WebAppHashing.calculateClientHash(\n          manifest,\n          type => type === 'css',\n          configOverrides\n        ),\n      versionNonRefreshable: () =>\n        WebAppHashing.calculateClientHash(\n          manifest,\n          (type, replaceable) => type !== 'css' && !replaceable,\n          configOverrides\n        ),\n      versionReplaceable: () =>\n        WebAppHashing.calculateClientHash(\n          manifest,\n          (_type, replaceable) => replaceable,\n          configOverrides\n        ),\n      cordovaCompatibilityVersions: programJson.cordovaCompatibilityVersions,\n      PUBLIC_SETTINGS,\n      hmrVersion: programJson.hmrVersion,\n    });\n\n    // Expose program details as a string reachable via the following URL.\n    const manifestUrlPrefix = '/__' + arch.replace(/^web\\./, '');\n    const manifestUrl = manifestUrlPrefix + getItemPathname('/manifest.json');\n\n    staticFiles[manifestUrl] = () => {\n      if (Package.autoupdate) {\n        const {\n          AUTOUPDATE_VERSION = Package.autoupdate.Autoupdate.autoupdateVersion,\n        } = process.env;\n\n        if (AUTOUPDATE_VERSION) {\n          newProgram.version = AUTOUPDATE_VERSION;\n        }\n      }\n\n      if (typeof newProgram.version === 'function') {\n        newProgram.version = newProgram.version();\n      }\n\n      return {\n        content: JSON.stringify(newProgram),\n        cacheable: false,\n        hash: newProgram.version,\n        type: 'json',\n      };\n    };\n\n    generateBoilerplateForArch(arch);\n\n    // If there are any requests waiting on oldProgram.paused, let them\n    // continue now (using the new program).\n    if (oldProgram && oldProgram.paused) {\n      oldProgram.unpause();\n    }\n  }\n\n  const defaultOptionsForArch = {\n    'web.cordova': {\n      runtimeConfigOverrides: {\n        // XXX We use absoluteUrl() here so that we serve https://\n        // URLs to cordova clients if force-ssl is in use. If we were\n        // to use __meteor_runtime_config__.ROOT_URL instead of\n        // absoluteUrl(), then Cordova clients would immediately get a\n        // HCP setting their DDP_DEFAULT_CONNECTION_URL to\n        // http://example.meteor.com. This breaks the app, because\n        // force-ssl doesn't serve CORS headers on 302\n        // redirects. (Plus it's undesirable to have clients\n        // connecting to http://example.meteor.com when force-ssl is\n        // in use.)\n        DDP_DEFAULT_CONNECTION_URL:\n          process.env.MOBILE_DDP_URL || Meteor.absoluteUrl(),\n        ROOT_URL: process.env.MOBILE_ROOT_URL || Meteor.absoluteUrl(),\n      },\n    },\n\n    'web.browser': {\n      runtimeConfigOverrides: {\n        isModern: true,\n      },\n    },\n\n    'web.browser.legacy': {\n      runtimeConfigOverrides: {\n        isModern: false,\n      },\n    },\n  };\n\n  WebAppInternals.generateBoilerplate = async function() {\n    // This boilerplate will be served to the mobile devices when used with\n    // Meteor/Cordova for the Hot-Code Push and since the file will be served by\n    // the device's server, it is important to set the DDP url to the actual\n    // Meteor server accepting DDP connections and not the device's file server.\n    await syncQueue.runTask(function() {\n      Object.keys(WebApp.clientPrograms).forEach(generateBoilerplateForArch);\n    });\n  };\n\n  function generateBoilerplateForArch(arch) {\n    const program = WebApp.clientPrograms[arch];\n    const additionalOptions = defaultOptionsForArch[arch] || {};\n    const { baseData } = (boilerplateByArch[\n      arch\n    ] = WebAppInternals.generateBoilerplateInstance(\n      arch,\n      program.manifest,\n      additionalOptions\n    ));\n    // We need the runtime config with overrides for meteor_runtime_config.js:\n    program.meteorRuntimeConfig = JSON.stringify({\n      ...__meteor_runtime_config__,\n      ...(additionalOptions.runtimeConfigOverrides || null),\n    });\n    program.refreshableAssets = baseData.css.map(file => ({\n      url: bundledJsCssUrlRewriteHook(file.url),\n    }));\n  }\n\n  await WebAppInternals.reloadClientPrograms();\n\n  // webserver\n  var app = createExpressApp()\n\n  // Packages and apps can add handlers that run before any other Meteor\n  // handlers via WebApp.rawExpressHandlers.\n  var rawExpressHandlers = createExpressApp()\n  app.use(rawExpressHandlers);\n\n  // Auto-compress any json, javascript, or text.\n  app.use(compress({ filter: shouldCompress }));\n\n  // parse cookies into an object\n  app.use(cookieParser());\n\n  // We're not a proxy; reject (without crashing) attempts to treat us like\n  // one. (See #1212.)\n  app.use(function(req, res, next) {\n    if (RoutePolicy.isValidUrl(req.url)) {\n      next();\n      return;\n    }\n    res.writeHead(400);\n    res.write('Not a proxy');\n    res.end();\n  });\n\n  function getPathParts(path) {\n    const parts = path.split('/');\n    while (parts[0] === '') parts.shift();\n    return parts;\n  }\n\n  function isPrefixOf(prefix, array) {\n    return (\n      prefix.length <= array.length &&\n      prefix.every((part, i) => part === array[i])\n    );\n  }\n\n  // Strip off the path prefix, if it exists.\n  app.use(function(request, response, next) {\n    const pathPrefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n    const { pathname, search } = parseUrl(request.url);\n\n    // check if the path in the url starts with the path prefix\n    if (pathPrefix) {\n      const prefixParts = getPathParts(pathPrefix);\n      const pathParts = getPathParts(pathname);\n      if (isPrefixOf(prefixParts, pathParts)) {\n        request.url = '/' + pathParts.slice(prefixParts.length).join('/');\n        if (search) {\n          request.url += search;\n        }\n        return next();\n      }\n    }\n\n    if (pathname === '/favicon.ico' || pathname === '/robots.txt') {\n      return next();\n    }\n\n    if (pathPrefix) {\n      response.writeHead(404);\n      response.write('Unknown path');\n      response.end();\n      return;\n    }\n\n    next();\n  });\n\n  // Serve static files from the manifest.\n  // This is inspired by the 'static' middleware.\n  app.use(function(req, res, next) {\n    // console.log(String(arguments.callee));\n    WebAppInternals.staticFilesMiddleware(\n      WebAppInternals.staticFilesByArch,\n      req,\n      res,\n      next\n    );\n  });\n\n  // Core Meteor packages like dynamic-import can add handlers before\n  // other handlers added by package and application code.\n  app.use((WebAppInternals.meteorInternalHandlers = createExpressApp()));\n\n  /**\n   * @name expressHandlersCallback(req, res, next)\n   * @locus Server\n   * @isprototype true\n   * @summary callback handler for `WebApp.expressHandlers`\n   * @param {Object} req\n   * a Node.js\n   * [IncomingMessage](https://nodejs.org/api/http.html#class-httpincomingmessage)\n   * object with some extra properties. This argument can be used\n   *  to get information about the incoming request.\n   * @param {Object} res\n   * a Node.js\n   * [ServerResponse](https://nodejs.org/api/http.html#class-httpserverresponse)\n   * object. Use this to write data that should be sent in response to the\n   * request, and call `res.end()` when you are done.\n   * @param {Function} next\n   * Calling this function will pass on the handling of\n   * this request to the next relevant handler.\n   *\n   */\n\n  /**\n   * @method handlers\n   * @memberof WebApp\n   * @locus Server\n   * @summary Register a handler for all HTTP requests.\n   * @param {String} [path]\n   * This handler will only be called on paths that match\n   * this string. The match has to border on a `/` or a `.`.\n   *\n   * For example, `/hello` will match `/hello/world` and\n   * `/hello.world`, but not `/hello_world`.\n   * @param {expressHandlersCallback} handler\n   * A handler function that will be called on HTTP requests.\n   * See `expressHandlersCallback`\n   *\n   */\n  // Packages and apps can add handlers to this via WebApp.expressHandlers.\n  // They are inserted before our default handler.\n  var packageAndAppHandlers = createExpressApp()\n  app.use(packageAndAppHandlers);\n\n  let suppressExpressErrors = false;\n  // Express knows it is an error handler because it has 4 arguments instead of\n  // 3. go figure.  (It is not smart enough to find such a thing if it's hidden\n  // inside packageAndAppHandlers.)\n  app.use(function(err, req, res, next) {\n    if (!err || !suppressExpressErrors || !req.headers['x-suppress-error']) {\n      next(err);\n      return;\n    }\n    res.writeHead(err.status, { 'Content-Type': 'text/plain' });\n    res.end('An error message');\n  });\n\n  app.use(async function(req, res, next) {\n    if (!appUrl(req.url)) {\n      return next();\n    } else if (\n      req.method !== 'HEAD' &&\n      req.method !== 'GET' &&\n      !Meteor.settings.packages?.webapp?.alwaysReturnContent\n    ) {\n      const status = req.method === 'OPTIONS' ? 200 : 405;\n      res.writeHead(status, {\n        Allow: 'OPTIONS, GET, HEAD',\n        'Content-Length': '0',\n      });\n      res.end();\n    } else {\n      var headers = {\n        'Content-Type': 'text/html; charset=utf-8',\n      };\n\n      if (shuttingDown) {\n        headers['Connection'] = 'Close';\n      }\n\n      var request = WebApp.categorizeRequest(req);\n\n      if (request.url.query && request.url.query['meteor_css_resource']) {\n        // In this case, we're requesting a CSS resource in the meteor-specific\n        // way, but we don't have it.  Serve a static css file that indicates that\n        // we didn't have it, so we can detect that and refresh.  Make sure\n        // that any proxies or CDNs don't cache this error!  (Normally proxies\n        // or CDNs are smart enough not to cache error pages, but in order to\n        // make this hack work, we need to return the CSS file as a 200, which\n        // would otherwise be cached.)\n        headers['Content-Type'] = 'text/css; charset=utf-8';\n        headers['Cache-Control'] = 'no-cache';\n        res.writeHead(200, headers);\n        res.write('.meteor-css-not-found-error { width: 0px;}');\n        res.end();\n        return;\n      }\n\n      if (request.url.query && request.url.query['meteor_js_resource']) {\n        // Similarly, we're requesting a JS resource that we don't have.\n        // Serve an uncached 404. (We can't use the same hack we use for CSS,\n        // because actually acting on that hack requires us to have the JS\n        // already!)\n        headers['Cache-Control'] = 'no-cache';\n        res.writeHead(404, headers);\n        res.end('404 Not Found');\n        return;\n      }\n\n      if (request.url.query && request.url.query['meteor_dont_serve_index']) {\n        // When downloading files during a Cordova hot code push, we need\n        // to detect if a file is not available instead of inadvertently\n        // downloading the default index page.\n        // So similar to the situation above, we serve an uncached 404.\n        headers['Cache-Control'] = 'no-cache';\n        res.writeHead(404, headers);\n        res.end('404 Not Found');\n        return;\n      }\n\n      const { arch } = request;\n      assert.strictEqual(typeof arch, 'string', { arch });\n\n      if (!hasOwn.call(WebApp.clientPrograms, arch)) {\n        // We could come here in case we run with some architectures excluded\n        headers['Cache-Control'] = 'no-cache';\n        res.writeHead(404, headers);\n        if (Meteor.isDevelopment) {\n          res.end(`No client program found for the ${arch} architecture.`);\n        } else {\n          // Safety net, but this branch should not be possible.\n          res.end('404 Not Found');\n        }\n        return;\n      }\n\n      // If pauseClient(arch) has been called, program.paused will be a\n      // Promise that will be resolved when the program is unpaused.\n      await WebApp.clientPrograms[arch].paused;\n\n      return getBoilerplateAsync(request, arch)\n        .then(({ stream, statusCode, headers: newHeaders }) => {\n          if (!statusCode) {\n            statusCode = res.statusCode ? res.statusCode : 200;\n          }\n\n          if (newHeaders) {\n            Object.assign(headers, newHeaders);\n          }\n\n          res.writeHead(statusCode, headers);\n\n          stream.pipe(res, {\n            // End the response when the stream ends.\n            end: true,\n          });\n        })\n        .catch(error => {\n          Log.error('Error running template: ' + error.stack);\n          res.writeHead(500, headers);\n          res.end();\n        });\n    }\n  });\n\n  // Return 404 by default, if no other handlers serve this URL.\n  app.use(function(req, res) {\n    res.writeHead(404);\n    res.end();\n  });\n\n  var httpServer = createServer(app);\n  var onListeningCallbacks = [];\n\n  // After 5 seconds w/o data on a socket, kill it.  On the other hand, if\n  // there's an outstanding request, give it a higher timeout instead (to avoid\n  // killing long-polling requests)\n  httpServer.setTimeout(SHORT_SOCKET_TIMEOUT);\n\n  // Do this here, and then also in livedata/stream_server.js, because\n  // stream_server.js kills all the current request handlers when installing its\n  // own.\n  httpServer.on('request', WebApp._timeoutAdjustmentRequestCallback);\n\n  // If the client gave us a bad request, tell it instead of just closing the\n  // socket. This lets load balancers in front of us differentiate between \"a\n  // server is randomly closing sockets for no reason\" and \"client sent a bad\n  // request\".\n  //\n  // This will only work on Node 6; Node 4 destroys the socket before calling\n  // this event. See https://github.com/nodejs/node/pull/4557/ for details.\n  httpServer.on('clientError', (err, socket) => {\n    // Pre-Node-6, do nothing.\n    if (socket.destroyed) {\n      return;\n    }\n\n    if (err.message === 'Parse Error') {\n      socket.end('HTTP/1.1 400 Bad Request\\r\\n\\r\\n');\n    } else {\n      // For other errors, use the default behavior as if we had no clientError\n      // handler.\n      socket.destroy(err);\n    }\n  });\n\n  const suppressErrors = function() {\n    suppressExpressErrors = true;\n  };\n\n  let warnedAboutConnectUsage = false;\n\n  // start up app\n  Object.assign(WebApp, {\n    connectHandlers: packageAndAppHandlers,\n    handlers: packageAndAppHandlers,\n    rawConnectHandlers: rawExpressHandlers,\n    rawHandlers: rawExpressHandlers,\n    httpServer: httpServer,\n    expressApp: app,\n    // For testing.\n    suppressConnectErrors: () => {\n      if (! warnedAboutConnectUsage) {\n        Meteor._debug(\"WebApp.suppressConnectErrors has been renamed to Meteor._suppressExpressErrors and it should be used only in tests.\");\n        warnedAboutConnectUsage = true;\n      }\n      suppressErrors();\n    },\n    _suppressExpressErrors: suppressErrors,\n    onListening: function(f) {\n      if (onListeningCallbacks) onListeningCallbacks.push(f);\n      else f();\n    },\n    // This can be overridden by users who want to modify how listening works\n    // (eg, to run a proxy like Apollo Engine Proxy in front of the server).\n    startListening: function(httpServer, listenOptions, cb) {\n      httpServer.listen(listenOptions, cb);\n    },\n  });\n\n    /**\n   * @name main\n   * @locus Server\n   * @summary Starts the HTTP server.\n   *  If `UNIX_SOCKET_PATH` is present Meteor's HTTP server will use that socket file for inter-process communication, instead of TCP.\n   * If you choose to not include webapp package in your application this method still must be defined for your Meteor application to work.\n   */\n  // Let the rest of the packages (and Meteor.startup hooks) insert Express\n  // middlewares and update __meteor_runtime_config__, then keep going to set up\n  // actually serving HTML.\n  exports.main = async argv => {\n    await WebAppInternals.generateBoilerplate();\n\n    const startHttpServer = listenOptions => {\n      WebApp.startListening(\n        argv?.httpServer || httpServer,\n        listenOptions,\n        Meteor.bindEnvironment(\n          () => {\n            if (process.env.METEOR_PRINT_ON_LISTEN) {\n              console.log('LISTENING');\n            }\n            const callbacks = onListeningCallbacks;\n            onListeningCallbacks = null;\n            callbacks?.forEach(callback => {\n              callback();\n            });\n          },\n          e => {\n            console.error('Error listening:', e);\n            console.error(e && e.stack);\n          }\n        )\n      );\n    };\n\n    let localPort = process.env.PORT || 0;\n    let unixSocketPath = process.env.UNIX_SOCKET_PATH;\n\n    if (unixSocketPath) {\n      if (cluster.isWorker) {\n        const workerName = cluster.worker.process.env.name || cluster.worker.id;\n        unixSocketPath += '.' + workerName + '.sock';\n      }\n      // Start the HTTP server using a socket file.\n      removeExistingSocketFile(unixSocketPath);\n      startHttpServer({ path: unixSocketPath });\n\n      const unixSocketPermissions = (\n        process.env.UNIX_SOCKET_PERMISSIONS || ''\n      ).trim();\n      if (unixSocketPermissions) {\n        if (/^[0-7]{3}$/.test(unixSocketPermissions)) {\n          chmodSync(unixSocketPath, parseInt(unixSocketPermissions, 8));\n        } else {\n          throw new Error('Invalid UNIX_SOCKET_PERMISSIONS specified');\n        }\n      }\n\n      const unixSocketGroup = (process.env.UNIX_SOCKET_GROUP || '').trim();\n      if (unixSocketGroup) {\n        const unixSocketGroupInfo = getGroupInfo(unixSocketGroup);\n        if (unixSocketGroupInfo === null) {\n          throw new Error('Invalid UNIX_SOCKET_GROUP name specified');\n        }\n        chownSync(unixSocketPath, userInfo().uid, unixSocketGroupInfo.gid);\n      }\n\n      registerSocketFileCleanup(unixSocketPath);\n    } else {\n      localPort = isNaN(Number(localPort)) ? localPort : Number(localPort);\n      if (/\\\\\\\\?.+\\\\pipe\\\\?.+/.test(localPort)) {\n        // Start the HTTP server using Windows Server style named pipe.\n        startHttpServer({ path: localPort });\n      } else if (typeof localPort === 'number') {\n        // Start the HTTP server using TCP.\n        startHttpServer({\n          port: localPort,\n          host: process.env.BIND_IP || '0.0.0.0',\n        });\n      } else {\n        throw new Error('Invalid PORT specified');\n      }\n    }\n\n    return 'DAEMON';\n  };\n}\n\nconst isGetentAvailable = () => {\n  try {\n    execSync('which getent');\n    return true;\n  } catch {\n    return false;\n  }\n};\n\nconst getGroupInfoUsingGetent = (groupName) => {\n  try {\n    const stdout = execSync(`getent group ${groupName}`, { encoding: 'utf8' });\n    if (!stdout) return null;\n    const [name, , gid] = stdout.trim().split(':');\n    if (name == null || gid == null) return null;\n    return { name, gid: Number(gid) };\n  } catch (error) {\n    return null;\n  }\n};\n\nconst getGroupInfoFromFile = (groupName) => {\n  try {\n    const data = readFileSync('/etc/group', 'utf8');\n    const groupLine = data.trim().split('\\n').find(line => line.startsWith(`${groupName}:`));\n    if (!groupLine) return null;\n    const [name, , gid] = groupLine.trim().split(':');\n    if (name == null || gid == null) return null;\n    return { name, gid: Number(gid) };\n  } catch (error) {\n    return null;\n  }\n};\n\nexport const getGroupInfo = (groupName) => {\n  let groupInfo = getGroupInfoFromFile(groupName);\n  if (!groupInfo && isGetentAvailable()) {\n    groupInfo = getGroupInfoUsingGetent(groupName);\n  }\n  return groupInfo;\n};\n\nvar inlineScriptsAllowed = true;\n\nWebAppInternals.inlineScriptsAllowed = function() {\n  return inlineScriptsAllowed;\n};\n\nWebAppInternals.setInlineScriptsAllowed = async function(value) {\n  inlineScriptsAllowed = value;\n  await WebAppInternals.generateBoilerplate();\n};\n\nvar sriMode;\n\nWebAppInternals.enableSubresourceIntegrity = async function(use_credentials = false) {\n  sriMode = use_credentials ? 'use-credentials' : 'anonymous';\n  await WebAppInternals.generateBoilerplate();\n};\n\nWebAppInternals.setBundledJsCssUrlRewriteHook = async function(hookFn) {\n  bundledJsCssUrlRewriteHook = hookFn;\n  await WebAppInternals.generateBoilerplate();\n};\n\nWebAppInternals.setBundledJsCssPrefix = async function(prefix) {\n  var self = this;\n  await self.setBundledJsCssUrlRewriteHook(function(url) {\n    return prefix + url;\n  });\n};\n\n// Packages can call `WebAppInternals.addStaticJs` to specify static\n// JavaScript to be included in the app. This static JS will be inlined,\n// unless inline scripts have been disabled, in which case it will be\n// served under `/<sha1 of contents>`.\nvar additionalStaticJs = {};\nWebAppInternals.addStaticJs = function(contents) {\n  additionalStaticJs['/' + sha1(contents) + '.js'] = contents;\n};\n\n// Exported for tests\nWebAppInternals.getBoilerplate = getBoilerplate;\nWebAppInternals.additionalStaticJs = additionalStaticJs;\n\nawait runWebAppServer();\n","import { statSync, unlinkSync, existsSync } from 'fs';\n\n// Since a new socket file will be created when the HTTP server\n// starts up, if found remove the existing file.\n//\n// WARNING:\n// This will remove the configured socket file without warning. If\n// the configured socket file is already in use by another application,\n// it will still be removed. Node does not provide a reliable way to\n// differentiate between a socket file that is already in use by\n// another application or a stale socket file that has been\n// left over after a SIGKILL. Since we have no reliable way to\n// differentiate between these two scenarios, the best course of\n// action during startup is to remove any existing socket file. This\n// is not the safest course of action as removing the existing socket\n// file could impact an application using it, but this approach helps\n// ensure the HTTP server can startup without manual\n// intervention (e.g. asking for the verification and cleanup of socket\n// files before allowing the HTTP server to be started).\n//\n// The above being said, as long as the socket file path is\n// configured carefully when the application is deployed (and extra\n// care is taken to make sure the configured path is unique and doesn't\n// conflict with another socket file path), then there should not be\n// any issues with this approach.\nexport const removeExistingSocketFile = (socketPath) => {\n  try {\n    if (statSync(socketPath).isSocket()) {\n      // Since a new socket file will be created, remove the existing\n      // file.\n      unlinkSync(socketPath);\n    } else {\n      throw new Error(\n        `An existing file was found at \"${socketPath}\" and it is not ` +\n        'a socket file. Please confirm PORT is pointing to valid and ' +\n        'un-used socket file path.'\n      );\n    }\n  } catch (error) {\n    // If there is no existing socket file to cleanup, great, we'll\n    // continue normally. If the caught exception represents any other\n    // issue, re-throw.\n    if (error.code !== 'ENOENT') {\n      throw error;\n    }\n  }\n};\n\n// Remove the socket file when done to avoid leaving behind a stale one.\n// Note - a stale socket file is still left behind if the running node\n// process is killed via signal 9 - SIGKILL.\nexport const registerSocketFileCleanup =\n  (socketPath, eventEmitter = process) => {\n    ['exit', 'SIGINT', 'SIGHUP', 'SIGTERM'].forEach(signal => {\n      eventEmitter.on(signal, Meteor.bindEnvironment(() => {\n        if (existsSync(socketPath)) {\n          unlinkSync(socketPath);\n        }\n      }));\n    });\n  };\n"]}