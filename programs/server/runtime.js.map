{"version":3,"names":["fs","require","path","createHash","Module","module","constructor","exports","enable","cachePath","createLoader","arguments","length","undefined","cacheEnabled","cacheEntries","Object","create","readdirSync","forEach","name","e","code","mkdirSync","Mp","prototype","resolve","id","_resolveFilename","moduleLoad","load","filename","result","apply","runSetters","resolved","Promise","dynamicImport","then","reifyVersion","version","reifyAcornParse","parse","reifyBabelParse","reifyCompile","compile","compileContent","content","identical","generateLetDeclarations","ast","acornError","_compile","options","compiledWithReify","call","jsExt","_extensions","js","stat","statSync","baseKey","update","concat","mtimeMs","ino","size","digest","identicalKey","key","readFileSync","join","origContent","writeFileLater","immediateTimer","pendingWrites","setImmediate","keys","targetPath","tempPath","writeFileSync","renameSync","err"],"sources":["/tools/static-assets/server/runtime.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst { createHash } = require(\"crypto\");\nconst Module = module.constructor;\n\nmodule.exports = function enable ({ cachePath, createLoader = true } = {}) {\n  let cacheEnabled = !!cachePath;\n  let cacheEntries = Object.create(null);\n\n  if (cachePath) {\n    try {\n      fs.readdirSync(cachePath).forEach(name => {\n        cacheEntries[name] = true;\n      });\n    } catch (e) {\n      if (e.code === 'ENOENT') {\n        fs.mkdirSync(cachePath);\n      } else {\n        cacheEnabled = false;\n      }\n    }\n  }\n\n  const Mp = Module.prototype;\n\n  Mp.resolve = function (id) {\n    return Module._resolveFilename(id, this);\n  };\n\n  // Enable the module.{watch,export,...} runtime API needed by Reify.\n  require(\"@meteorjs/reify/lib/runtime\").enable(Mp);\n\n  const moduleLoad = Mp.load;\n  Mp.load = function (filename) {\n    const result = moduleLoad.apply(this, arguments);\n    if (typeof this.runSetters === \"function\") {\n      // Make sure we call module.runSetters (or module.runModuleSetters, a\n      // legacy synonym) whenever a module finishes loading.\n      this.runSetters();\n    }\n    return result;\n  };\n\n  const resolved = Promise.resolve();\n  Mp.dynamicImport = function (id) {\n    return resolved.then(() => require(id));\n  };\n\n  const reifyVersion = require(\"@meteorjs/reify/package.json\").version;\n  const reifyAcornParse = require(\"@meteorjs/reify/lib/parsers/acorn\").parse;\n  const reifyBabelParse = require(\"@meteorjs/reify/lib/parsers/babel\").parse;\n  const reifyCompile = require(\"@meteorjs/reify/lib/compiler\").compile;\n\n  function compileContent (content) {\n    let identical = true;\n\n    let result;\n    try {\n      result = reifyCompile(content, {\n        parse: reifyAcornParse,\n        generateLetDeclarations: false,\n        ast: false,\n      });\n      if (!result.identical) {\n        identical = false;\n        content = result.code;\n      }\n    } catch (acornError) {\n      // Fallback: Babel\n      result = reifyCompile(content, {\n        parse: reifyBabelParse,\n        generateLetDeclarations: false,\n        ast: false,\n      });\n      if (!result.identical) {\n        identical = false;\n        content = result.code;\n      }\n    }\n\n    return { content, identical };\n  }\n\n  const _compile = Mp._compile;\n  Mp._compile = function (content, filename, options) {\n    // When cache is enabled, the file has already been compiled\n    if (!options || !options.compiledWithReify) {\n      content = compileContent(content).content;\n    }\n\n    return _compile.call(this, content, filename);\n  };\n\n  if (cacheEnabled) {\n    const jsExt = Module._extensions.js;\n    Module._extensions['.js'] = function (module, filename) {\n      let stat = fs.statSync(filename);\n      let baseKey = createHash(\"sha1\")\n        .update(`${reifyVersion}\\0${filename}\\0${stat.mtimeMs}\\0${stat.ino}\\0${stat.size}\\0`)\n        .digest('hex');\n\n      // When files don't use import/export, there is no reason to store\n      // an identical copy of the file in the cache. Instead, it stores an empty\n      // file with a different suffix to indicate the original file should be used\n      let identicalKey = baseKey + '-identical.json';\n      let key = baseKey + '.json';\n\n      let content;\n      if (cacheEntries[key]) {\n        content = fs.readFileSync(path.join(cachePath, key), 'utf8');\n      } else if (cacheEntries[identicalKey]) {\n        content = fs.readFileSync(filename, 'utf8');\n      } else {\n        let origContent = fs.readFileSync(filename, 'utf8');\n        let result = compileContent(origContent);\n        content = result.content;\n\n        if (result.identical) {\n          writeFileLater(identicalKey, '');\n        } else {\n          writeFileLater(key, content);\n        }\n      }\n\n      return module._compile(content, filename, { compiledWithReify: true });\n    }\n  }\n\n  let immediateTimer = null;\n  let pendingWrites = Object.create(null);\n  function writeFileLater(key, content) {\n    pendingWrites[key] = content;\n    if (immediateTimer !== null) {\n      return;\n    }\n\n    immediateTimer = setImmediate(() => {\n      immediateTimer = null;\n      Object.keys(pendingWrites).forEach(key => {\n        try {\n          let targetPath = path.resolve(cachePath, key);\n          let tempPath = targetPath + '.tmp';\n          fs.writeFileSync(tempPath, pendingWrites[key]);\n          fs.renameSync(tempPath, targetPath);\n        } catch (err) {\n        }\n      });\n\n      pendingWrites = Object.create(null);\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[],"file":"tools/static-assets/server/runtime.js.map"}